<include file="Public:header" />
  <title>导航地图</title>
  <style type="text/css">
    html,body{
      height:100%;
    }
  </style>
</head>
<body>
  <div id="map" style="width:100%;height:100%;">请稍候，地图载入中...</div>  
  <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=psl3oLH8uR0C3PXK2DRhdsG2"></script>
  <script type="text/javascript">
    // 百度地图API功能
    var map = new BMap.Map("map");
    var point = new BMap.Point(110.366147,20.054353);
    map.centerAndZoom(point,15);
    var startPoint = new BMap.Point(110.366147,20.054353);    //起点
    var endPoint = new BMap.Point(110.367755,20.033672);    //终点

    var myIcon = new BMap.Icon("http://developer.baidu.com/map/jsdemo/img/Mario.png", new BMap.Size(32, 70), {    //小车图片
      //offset: new BMap.Size(0, -5),    //相当于CSS精灵
      imageOffset: new BMap.Size(0, 0)    //图片的偏移量。为了是图片底部中心对准坐标点。
      });

    var geolocation = new BMap.Geolocation();
    geolocation.getCurrentPosition(function(r){
      if(this.getStatus() == BMAP_STATUS_SUCCESS){
        var mk = new BMap.Marker(r.point);
        map.addOverlay(mk);
        map.panTo(r.point);
        startPoint=r.point

        var driving2 = new BMap.DrivingRoute(map, {renderOptions:{map: map, autoViewport: true}});    //驾车实例
        driving2.search(startPoint, endPoint);    //显示一条公交线路
        //导航
        run();
        //alert('您的位置：'+r.point.lng+','+r.point.lat);
      }
      else {
        alert('failed'+this.getStatus());
      }        
    },{enableHighAccuracy: true})
    //关于状态码
    //BMAP_STATUS_SUCCESS 检索成功。对应数值“0”。
    //BMAP_STATUS_CITY_LIST 城市列表。对应数值“1”。
    //BMAP_STATUS_UNKNOWN_LOCATION  位置结果未知。对应数值“2”。
    //BMAP_STATUS_UNKNOWN_ROUTE 导航结果未知。对应数值“3”。
    //BMAP_STATUS_INVALID_KEY 非法密钥。对应数值“4”。
    //BMAP_STATUS_INVALID_REQUEST 非法请求。对应数值“5”。
    //BMAP_STATUS_PERMISSION_DENIED 没有权限。对应数值“6”。(自 1.1 新增)
    //BMAP_STATUS_SERVICE_UNAVAILABLE 服务不可用。对应数值“7”。(自 1.1 新增)
    //BMAP_STATUS_TIMEOUT 超时。对应数值“8”。(自 1.1 新增)


    window.run = function (){
      var driving = new BMap.DrivingRoute(map);    //驾车实例
      driving.search(startPoint, endPoint);
      driving.setSearchCompleteCallback(function(){
        var pts = driving.getResults().getPlan(0).getRoute(0).getPath();    //通过驾车实例，获得一系列点的数组
        var paths = pts.length;    //获得有几个点

        var carMk = new BMap.Marker(pts[0],{icon:myIcon});
        map.addOverlay(carMk);
        i=0;
        function resetMkPoint(i){
          carMk.setPosition(pts[i]);
          if(i < paths){
            setTimeout(function(){
              i++;
              resetMkPoint(i);
            },100);
          }
        }
        setTimeout(function(){
          resetMkPoint(5);
        },100)

      });
    }


  </script>
<include file="Public:footer" />